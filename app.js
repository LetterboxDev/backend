//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Module dependencies
//////////////////////////////////////////////////////////////////////////////////////////////////////////////

var express = require('express'),
    http = require('http'),
    fs = require('fs'),
    path = require('path'),
    bodyParser = require('body-parser'),
    methodOverride = require('method-override');

// Load app configuration
var env = process.env.NODE_ENV || 'development',
    config = require('./config/config')[env];

var app = express();

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Express configuration
//////////////////////////////////////////////////////////////////////////////////////////////////////////////

app.set('port', process.env.PORT || 8080);
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(methodOverride());

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Models
//////////////////////////////////////////////////////////////////////////////////////////////////////////////

var db = require(__dirname + '/config/mongoose');

//////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Controllers
//////////////////////////////////////////////////////////////////////////////////////////////////////////////

var controllersDir = __dirname + '/app/controllers',
    files = fs.readdirSync(controllersDir);

files.forEach(function (file) {
    controller = require(controllersDir + '/' + file);
    controller.init(app);
    console.log("Added controller: " + file);
});


//////////////////////////////////////////////////////////////////////////////////////////////////////////
// Server
//////////////////////////////////////////////////////////////////////////////////////////////////////////

var server = http.createServer(app).listen(app.get('port'), function(){
  console.log("Letterbox backend listening on port " + app.get('port'));
});

//////////////////////////////////////////////////////////////////////////////////////////////////////////
// socket.io configuration
//////////////////////////////////////////////////////////////////////////////////////////////////////////

require(__dirname + '/app/sockets/socket').init(server);